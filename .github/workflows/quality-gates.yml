# ReasonKit Core - Quality Gates CI/CD
# Enforces CONS-009: All 5 quality gates must pass

name: Quality Gates

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # GATE 1: Build Check (BLOCKING)
  # ═══════════════════════════════════════════════════════════════════════════
  gate1-build:
    name: "Gate 1: Build"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build (release)
        run: cargo build --release

      - name: Build (all features)
        run: cargo build --all-features

  # ═══════════════════════════════════════════════════════════════════════════
  # GATE 2: Lint with Clippy (BLOCKING)
  # ═══════════════════════════════════════════════════════════════════════════
  gate2-lint:
    name: "Gate 2: Clippy"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy
        run: cargo clippy -- -D warnings

      - name: Run Clippy (all features)
        run: cargo clippy --all-features -- -D warnings

  # ═══════════════════════════════════════════════════════════════════════════
  # GATE 3: Format Check (BLOCKING)
  # ═══════════════════════════════════════════════════════════════════════════
  gate3-format:
    name: "Gate 3: Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --check

  # ═══════════════════════════════════════════════════════════════════════════
  # GATE 4: Tests (BLOCKING)
  # ═══════════════════════════════════════════════════════════════════════════
  gate4-test:
    name: "Gate 4: Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features

      - name: Run doc tests
        run: cargo test --doc

  # ═══════════════════════════════════════════════════════════════════════════
  # GATE 5: Benchmarks (MONITORING - not blocking)
  # ═══════════════════════════════════════════════════════════════════════════
  gate5-bench:
    name: "Gate 5: Benchmarks"
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'performance') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: cargo bench --bench retrieval_bench -- --noplot || echo "Benchmarks need setup"

  # ═══════════════════════════════════════════════════════════════════════════
  # Quality Metrics Collection
  # ═══════════════════════════════════════════════════════════════════════════
  metrics:
    name: "Quality Metrics"
    runs-on: ubuntu-latest
    needs: [gate1-build, gate2-lint, gate3-format, gate4-test]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Calculate metrics
        run: |
          echo "## Quality Metrics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines of Rust | $(find src -name '*.rs' -exec cat {} \; | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| TODO count | $(grep -r 'TODO' src --include='*.rs' | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| FIXME count | $(grep -r 'FIXME' src --include='*.rs' | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Unsafe blocks | $(grep -r 'unsafe' src --include='*.rs' | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All quality gates passed!" >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════════════════════
  # Security Audit
  # ═══════════════════════════════════════════════════════════════════════════
  security:
    name: "Security Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit || echo "⚠️ Security audit found issues"
        continue-on-error: true
