# ReasonKit Core - Production Docker Compose
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.prod.yml logs -f reasonkit-core
#   docker compose -f docker-compose.prod.yml down
#
# Requirements:
#   - .env file with API keys and secrets
#   - SSL certificates in ./nginx/ssl/ (for HTTPS)
#   - Prometheus config in ./monitoring/prometheus.yml
#
# Exposed Ports:
#   - 80/443: NGINX reverse proxy
#   - 9090: Prometheus metrics (internal)
#   - 3000: Grafana dashboards (internal)

networks:
  reasonkit:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

  monitoring:
    driver: bridge
    internal: true

volumes:
  qdrant-data:
    driver: local
  reasonkit-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

services:
  # ===========================================================================
  # ReasonKit Core - Production Instance
  # ===========================================================================
  reasonkit-core:
    image: reasonkit/core:${VERSION:-latest}
    container_name: reasonkit-core-prod
    restart: always

    networks:
      - reasonkit
      - monitoring

    volumes:
      - reasonkit-data:/app/data
      - ./config:/app/config:ro
      - ./protocols:/app/protocols:ro

    environment:
      REASONKIT_ENV: "production"
      REASONKIT_LOG_LEVEL: "${LOG_LEVEL:-info}"
      RUST_LOG: "reasonkit=info,tower_http=warn"
      RUST_BACKTRACE: "0"

      REASONKIT_HOST: "0.0.0.0"
      REASONKIT_PORT: "8080"

      QDRANT_URL: "http://qdrant:6334"
      REDIS_URL: "redis://redis:6379"

      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"

      # Security
      REASONKIT_CORS_ORIGINS: "${CORS_ORIGINS:-https://reasonkit.sh}"
      REASONKIT_RATE_LIMIT: "${RATE_LIMIT:-100}"

    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777

    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 8G
        reservations:
          cpus: "1.0"
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # ===========================================================================
  # Qdrant - Vector Database (Production)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.12.5
    container_name: reasonkit-qdrant-prod
    restart: always

    networks:
      - reasonkit
      - monitoring

    volumes:
      - qdrant-data:/qdrant/storage

    environment:
      QDRANT__SERVICE__HTTP_PORT: "6333"
      QDRANT__SERVICE__GRPC_PORT: "6334"
      QDRANT__LOG_LEVEL: "WARN"
      QDRANT__STORAGE__WAL_CAPACITY_MB: "128"
      QDRANT__STORAGE__PERFORMANCE__INDEXING_THRESHOLD_KB: "100"
      QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB: "20000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  # ===========================================================================
  # Redis - Caching Layer (Production)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: reasonkit-redis-prod
    restart: always

    networks:
      - reasonkit
      - monitoring

    volumes:
      - redis-data:/data

    command: >
      redis-server
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 300 10
      --save 60 10000
      --loglevel warning
      --tcp-keepalive 60

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 512M

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  # ===========================================================================
  # NGINX - Reverse Proxy with SSL
  # ===========================================================================
  nginx:
    image: nginx:1.27-alpine
    container_name: reasonkit-nginx-prod
    restart: always

    ports:
      - "80:80"
      - "443:443"

    networks:
      - reasonkit

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro

    depends_on:
      reasonkit-core:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  # ===========================================================================
  # Prometheus - Metrics Collection
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v3.0.0
    container_name: reasonkit-prometheus-prod
    restart: always

    networks:
      - monitoring

    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 512M

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  # ===========================================================================
  # Grafana - Metrics Visualization
  # ===========================================================================
  grafana:
    image: grafana/grafana:11.4.0
    container_name: reasonkit-grafana-prod
    restart: always

    networks:
      - monitoring

    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro

    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "${GRAFANA_ROOT_URL:-http://localhost:3000}"
      GF_LOG_LEVEL: "warn"

    depends_on:
      - prometheus

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M

    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"
