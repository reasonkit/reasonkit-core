# ReasonKit Core - Local Development Docker Compose
#
# Usage:
#   docker compose up              # Start all services
#   docker compose up -d           # Start in background
#   docker compose up --build      # Rebuild and start
#   docker compose logs -f         # Follow logs
#   docker compose down            # Stop all services
#   docker compose down -v         # Stop and remove volumes
#
# Services:
#   - reasonkit-core: Main application
#   - qdrant: Vector database
#   - redis: Caching layer
#
# Development:
#   docker compose --profile dev up  # Start with development container

networks:
  reasonkit:
    driver: bridge

volumes:
  # Persistent storage for vector database
  qdrant-data:
    driver: local

  # Persistent storage for application data
  reasonkit-data:
    driver: local

  # Redis cache data
  redis-data:
    driver: local

  # Cargo cache for faster rebuilds (dev mode)
  cargo-cache:
    driver: local

services:
  # ===========================================================================
  # ReasonKit Core - Main Application
  # ===========================================================================
  reasonkit-core:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        FEATURES: "cli"
        VERSION: "0.1.0"
        BUILD_DATE: "${BUILD_DATE:-}"
        VCS_REF: "${VCS_REF:-}"
    image: reasonkit/core:latest
    container_name: reasonkit-core
    restart: unless-stopped

    ports:
      - "8080:8080"

    networks:
      - reasonkit

    volumes:
      # Persistent data storage
      - reasonkit-data:/app/data
      # Configuration (read-only in production)
      - ./config:/app/config:ro
      # Protocols (read-only)
      - ./protocols:/app/protocols:ro
      # Output directory (writable)
      - ./output:/app/output

    environment:
      # Application configuration
      REASONKIT_ENV: "development"
      REASONKIT_LOG_LEVEL: "debug"
      RUST_LOG: "reasonkit=debug,tower_http=debug"
      RUST_BACKTRACE: "1"

      # Server settings
      REASONKIT_HOST: "0.0.0.0"
      REASONKIT_PORT: "8080"

      # External services
      QDRANT_URL: "http://qdrant:6334"
      REDIS_URL: "redis://redis:6379"

      # API keys (from .env file)
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"

    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits for local development
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # ===========================================================================
  # Qdrant - Vector Database
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.12.5
    container_name: reasonkit-qdrant
    restart: unless-stopped

    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API

    networks:
      - reasonkit

    volumes:
      - qdrant-data:/qdrant/storage

    environment:
      QDRANT__SERVICE__HTTP_PORT: "6333"
      QDRANT__SERVICE__GRPC_PORT: "6334"
      QDRANT__LOG_LEVEL: "INFO"
      # Performance tuning
      QDRANT__STORAGE__WAL_CAPACITY_MB: "32"
      QDRANT__STORAGE__PERFORMANCE__INDEXING_THRESHOLD_KB: "20"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # ===========================================================================
  # Redis - Caching Layer
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: reasonkit-redis
    restart: unless-stopped

    ports:
      - "6379:6379"

    networks:
      - reasonkit

    volumes:
      - redis-data:/data

    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1
      --loglevel notice

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M

  # ===========================================================================
  # Development Container (optional profile)
  # ===========================================================================
  dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: reasonkit-dev

    networks:
      - reasonkit

    volumes:
      # Mount source code for hot-reload
      - .:/workspace
      # Cargo cache for faster rebuilds
      - cargo-cache:/home/developer/.cargo
      # Prevent overwriting target directory
      - /workspace/target

    environment:
      RUST_LOG: "debug"
      RUST_BACKTRACE: "full"
      CARGO_INCREMENTAL: "1"

      # External services
      QDRANT_URL: "http://qdrant:6334"
      REDIS_URL: "redis://redis:6379"

      # API keys
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"

    depends_on:
      - qdrant
      - redis

    stdin_open: true
    tty: true

    # Hot-reload with cargo-watch
    command: ["cargo", "watch", "-x", "run -- serve"]
